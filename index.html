<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AnimePro v1.5 | Premium Player</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Oswald:wght@500;700&family=Roboto:wght@400;700&display=swap');
        :root { --primary: #F47521; --bg: #050505; --surface: #121212; --text: #fff; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Roboto', sans-serif; background: var(--bg); color: var(--text); }

        /* HEADER & CATEGORIAS */
        header { padding: 15px 5%; background: #000; display: flex; justify-content: space-between; align-items: center; sticky; top: 0; z-index: 1000; border-bottom: 2px solid var(--primary); }
        .categories { background: #111; padding: 10px 5%; overflow-x: auto; white-space: nowrap; display: flex; gap: 15px; border-bottom: 1px solid #333; }
        .categories button { background: none; border: 1px solid #444; color: #ccc; padding: 5px 15px; border-radius: 20px; cursor: pointer; font-size: 13px; }
        .categories button:hover { border-color: var(--primary); color: var(--primary); }

        /* GRID */
        .grid { display: grid; padding: 20px 5%; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; }
        .card { background: var(--surface); border-radius: 8px; overflow: hidden; cursor: pointer; transition: 0.3s; border: 1px solid #222; }
        .card:hover { transform: scale(1.05); border-color: var(--primary); }
        .card img { width: 100%; height: 230px; object-fit: cover; }
        .card-info { padding: 10px; text-align: center; font-size: 13px; font-weight: bold; }

        /* MODAL E PLAYER MENOR */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; padding: 20px; overflow-y: auto; }
        .modal-content { max-width: 800px; margin: auto; background: #111; padding: 20px; border-radius: 10px; border: 1px solid #333; }
        
        .player-area { background: #000; width: 100%; max-width: 600px; margin: 0 auto; aspect-ratio: 16/9; border: 1px solid var(--primary); display: none; }
        iframe { width: 100%; height: 100%; border: none; }

        .controls { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; }
        .selectors { display: flex; gap: 10px; flex-wrap: wrap; }
        select { background: #222; color: white; border: 1px solid #444; padding: 10px; border-radius: 5px; flex: 1; min-width: 150px; }
        
        .btn-external { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 5px; cursor: pointer; font-weight: bold; text-align: center; text-decoration: none; display: block; margin-top: 10px; }

        .ep-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 8px; margin-top: 15px; max-height: 200px; overflow-y: auto; padding: 5px; }
        .ep-item { background: #333; padding: 10px; text-align: center; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .ep-item:hover { background: var(--primary); }
        .close { float: right; font-size: 30px; color: var(--primary); cursor: pointer; }
    </style>
</head>
<body>

<header>
    <div class="logo">ANIME<span>PRO</span></div>
    <input type="text" id="searchInput" placeholder="Buscar..." oninput="debounceSearch()" style="padding:8px; border-radius:5px; border:none; background:#222; color:white; width:200px;">
</header>

<div class="categories">
    <button onclick="loadByGenre(1)">Ação</button>
    <button onclick="loadByGenre(2)">Aventura</button>
    <button onclick="loadByGenre(4)">Comédia</button>
    <button onclick="loadByGenre(8)">Drama</button>
    <button onclick="loadByGenre(10)">Fantasia</button>
    <button onclick="loadByGenre(22)">Romance</button>
    <button onclick="loadByGenre(24)">Sci-Fi</button>
    <button onclick="loadByGenre(27)">Shounen</button>
</div>

<div class="grid" id="mainGrid"></div>

<div id="mainModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2 id="modalTitle">Título do Anime</h2>
        
        <div class="controls">
            <div class="selectors">
                <select id="seasonSelect">
                    <option value="1">1ª Temporada</option>
                    <option value="2">2ª Temporada</option>
                    <option value="3">3ª Temporada</option>
                </select>
                <select id="langSelect">
                    <option value="legendado">Legendado</option>
                    <option value="dublado">Dublado</option>
                </select>
            </div>
            
            <a id="btnNovaAba" href="#" target="_blank" class="btn-external">ASSISTIR EM NOVA ABA (TELA CHEIA)</a>
            <p style="font-size: 11px; color: #888; text-align: center;">Ou assista abaixo no player reduzido:</p>
            
            <div class="player-area" id="playerArea">
                <iframe id="miniPlayer" src="" allowfullscreen></iframe>
            </div>
        </div>

        <div class="ep-grid" id="epGrid"></div>
    </div>
</div>

<script>
    let currentItem = null;
    let searchTimeout;

    async function loadData(url = 'https://api.jikan.moe/v4/top/anime?limit=24') {
        const grid = document.getElementById('mainGrid');
        grid.innerHTML = "Carregando...";
        try {
            const resp = await fetch(url);
            const data = await resp.json();
            render(data.data);
        } catch (e) { grid.innerHTML = "Erro ao carregar."; }
    }

    function render(items) {
        const grid = document.getElementById('mainGrid');
        grid.innerHTML = items.map(item => `
            <div class="card" onclick='openModal(${JSON.stringify(item).replace(/'/g, "&apos;")})'>
                <img src="${item.images.jpg.image_url}">
                <div class="card-info">${item.title}</div>
            </div>
        `).join('');
    }

    function loadByGenre(id) {
        loadData(`https://api.jikan.moe/v4/anime?genres=${id}&order_by=popularity&limit=24`);
    }

    function openModal(item) {
        currentItem = item;
        document.getElementById('modalTitle').innerText = item.title;
        document.getElementById('mainModal').style.display = 'block';
        
        const epGrid = document.getElementById('epGrid');
        epGrid.innerHTML = "";
        const total = item.episodes || 12;

        for(let i=1; i<=total; i++) {
            const div = document.createElement('div');
            div.className = 'ep-item';
            div.innerText = i;
            div.onclick = () => prepareVideo(i);
            epGrid.appendChild(div);
        }
    }

    function prepareVideo(ep) {
        const season = document.getElementById('seasonSelect').value;
        const lang = document.getElementById('langSelect').value;
        const id = currentItem.mal_id;
        
        // Lógica Paliativa de URL (Sem YouTube)
        // Montamos a URL baseada no ID para o servidor de animes
        let finalUrl = `https://embedder.net/e/anime/${id}/${ep}`;
        if(lang === 'dublado') finalUrl = `https://embedder.net/e/anime/${id}-dublado/${ep}`;

        // Opção 1: Player Menor
        const playerArea = document.getElementById('playerArea');
        playerArea.style.display = 'block';
        document.getElementById('miniPlayer').src = finalUrl;

        // Opção 2: Nova Aba
        const btnAba = document.getElementById('btnNovaAba');
        btnAba.href = finalUrl;
        
        alert(`Episódio ${ep} preparado! Você pode assistir abaixo ou clicar no botão laranja para abrir em outra aba.`);
    }

    function closeModal() {
        document.getElementById('mainModal').style.display = 'none';
        document.getElementById('miniPlayer').src = "";
        document.getElementById('playerArea').style.display = 'none';
    }

    function debounceSearch() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            const q = document.getElementById('searchInput').value;
            loadData(`https://api.jikan.moe/v4/anime?q=${q}&limit=24`);
        }, 800);
    }

    loadData();
</script>
</body>
</html>